# Docker Compose file for testing Lemmy UI image
# This file sets up a complete Lemmy instance to test the UI image: dessalines/lemmy-ui:0.19.15-alpha.1

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "4"

services:
  proxy:
    image: docker.io/library/nginx:latest
    ports:
      - "1236:8536"
    volumes:
      - ./test-nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped
    logging: *default-logging
    depends_on:
      - lemmy-ui
      - lemmy
    networks:
      - lemmy-test

  lemmy:
    image: dessalines/lemmy:0.19.15-alpha.1
    hostname: lemmy
    restart: unless-stopped
    logging: *default-logging
    environment:
      - RUST_LOG=warn
      - RUST_BACKTRACE=1
    volumes:
      - ./test-lemmy.hjson:/config/config.hjson:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - lemmy-test

  lemmy-ui:
    image: dessalines/lemmy-ui:0.19.15-alpha.1
    hostname: lemmy-ui
    restart: unless-stopped
    logging: *default-logging
    environment:
      - LEMMY_UI_LEMMY_INTERNAL_HOST=lemmy:8536
      - LEMMY_UI_LEMMY_EXTERNAL_HOST=localhost:1236
      - LEMMY_UI_HTTPS=false
    depends_on:
      - lemmy
    networks:
      - lemmy-test

  pictrs:
    image: docker.io/asonix/pictrs:0.5
    hostname: pictrs
    environment:
      - PICTRS__SERVER__API_KEY=test-api-key-123
      - RUST_LOG=info
    user: 991:991
    volumes:
      - pictrs-data:/mnt
    restart: unless-stopped
    logging: *default-logging
    networks:
      - lemmy-test

  postgres:
    image: docker.io/postgres:16-alpine
    hostname: postgres
    environment:
      - POSTGRES_USER=lemmy
      - POSTGRES_PASSWORD=test-password-123
      - POSTGRES_DB=lemmy
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lemmy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lemmy-test

networks:
  lemmy-test:
    driver: bridge

volumes:
  postgres-data:
  pictrs-data:
